#
# Author: Makoto Inoue
#
# Example Twitter REST source adapter for PublicTimeLine
#
# <?xml version="1.0" encoding="UTF-8"?>
# <statuses type="array">
#     <status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415806</id>
#       <text>@daguayo tengo Serenity en 'backup' y la vi en el cine. La serie, Firefly, la estoy buscando.</text>
#       <source><a href="http://twitterfon.net/">TwitterFon</a></source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id>1164343113</in_reply_to_status_id>
#       <in_reply_to_user_id>8026382</in_reply_to_user_id>
#       <favorited>false</favorited>
#       <user>
#       <id>6409422</id>
#
#       <name>Moki</name>
#       <screen_name>mokibcn</screen_name>
#       <description />
#       <location>iPhone: 41.405987,2.196104</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/69154148/exito-nocturno_normal.jpg</profile_image_url>
#       <url />
#       <protected>false</protected>
#
#       <followers_count>247</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415805</id>
#       <text>@phusick Na tento rozdíl jsem přišel až po první slovenské objednávce. Doslova to bylo jídlo za poslední peníze.</text>
#       <source><a href="http://twitterfox.net/">TwitterFox</a></source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id>12493922</in_reply_to_user_id>
#       <favorited>false</favorited>
#       <user>
#       <id>14336211</id>
#       <name>Tomáš Kalina</name>
#
#       <screen_name>forest_cz</screen_name>
#       <description>univesity student, sportsman (marathon and triathlon), sometimes IT developer</description>
#       <location>Brno or Havířov, Czech republi</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/53154467/forest_normal.jpg</profile_image_url>
#       <url>http://www.tomas-kalina.com</url>
#       <protected>false</protected>
#
#       <followers_count>47</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415804</id>
#       <text>@as1mo  そんなこと言うと強烈に貧乏ゆすりしますよ！いいんですか！？</text>
#       <source><a href="http://cheebow.info/chemt/archives/2007/04/twitterwindowst.html">Twit</a></source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id>1165413513</in_reply_to_status_id>
#       <in_reply_to_user_id>10657842</in_reply_to_user_id>
#       <favorited>false</favorited>
#       <user>
#       <id>17248438</id>
#
#       <name>Y.Moa</name>
#       <screen_name>YERON</screen_name>
#       <description>自動車とかコーヒーが好き♪アドエス使ってます。つまらないブログの管理人らしい。</description>
#       <location>太陽系第三惑星</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production /profile_images/74165190/いえろん_normal.jpg</profile_image_url>
#       <url>http://chaoticroom.blog94.fc2.com/</url>
#
#       <protected>false</protected>
#       <followers_count>67</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415803</id>
#       <text>@choadmalma ya animal collective!!!!!</text>
#
#       <source>web</source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id>1165297697</in_reply_to_status_id>
#       <in_reply_to_user_id>16522244</in_reply_to_user_id>
#       <favorited>false</favorited>
#       <user>
#
#       <id>15200257</id>
#       <name>mattgcn</name>
#       <screen_name>mattgcn</screen_name>
#       <description>I'm Matt and Twitter is a wonderful waste of my time.</description>
#       <location>Canada</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/73186923/avatarQ__normal.PNG</profile_image_url>
#
#       <url>http://mattgcn.illemonati.com/</url>
#       <protected>false</protected>
#       <followers_count>25</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415801</id>
#
#       <text>@holisticmamma Oh good. She will love it! Let me know how it works out.</text>
#       <source><a href="http://www.tweetdeck.com/">TweetDeck</a></source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id>1165413359</in_reply_to_status_id>
#       <in_reply_to_user_id>15708087</in_reply_to_user_id>
#
#       <favorited>false</favorited>
#       <user>
#       <id>14346911</id>
#       <name>KelliClaypool</name>
#       <screen_name>krclaypool</screen_name>
#       <description>Unconventional Business Coach, Writer, Blogger, Webmaster, Marketing Diva, Mom, and Wife</description>
#
#       <location>Online Everywhere!</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/57576806/kc_pic_normal.jpg</profile_image_url>
#       <url>http://BriefcaseDiva.wordpress.com</url>
#       <protected>false</protected>
#       <followers_count>632</followers_count>
#     </user>
#
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415798</id>
#       <text>正面突破でイセカイ界待機</text>
#       <source><a href="http://d.hatena.ne.jp/Kiri_Feather/20071121">Tween</a></source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#       <id>9748512</id>
#       <name>怖いよ、うらーん</name>
#
#       <screen_name>eikara</screen_name>
#       <description>貧乏大学生、夢玉使い修行中、ガンダム/小説/マンガ/異形コレクション　バトスピやってます。　挨拶BOTですが悪しからず follow/remove/blockはご自由に～</description>
#       <location>Hokkaidou,JAPAN</location>
#       <profile_image_url>http://static.twitter.com/images/default_profile_normal.png</profile_image_url>
#       <url></url>
#       <protected>false</protected>
#
#       <followers_count>506</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415797</id>
#       <text>On slower train, can't drink beer in front of me... Need sleep now.</text>
#       <source><a href="http://www.tinytwitter.com/">TinyTwitter</a></source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#       <id>15072391</id>
#       <name>Carl Haggerty</name>
#
#       <screen_name>carlhaggerty</screen_name>
#       <description>Passionate about social communications, web 2.0 and social media in the UK public sector</description>
#       <location>Exeter, UK</location>
#       <profile_image_url>http://static.twitter.com/images/default_profile_normal.png</profile_image_url>
#       <url>http://carlhaggerty.wordpress.com</url>
#       <protected>false</protected>
#
#       <followers_count>361</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415796</id>
#       <text>@John_Corey seemed odd to me when I first saw it. Twitterfall uses "via" as well. @tweetgrid does it "right" :) @twhirl lets you decide.</text>
#
#       <source>web</source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id>1165410553</in_reply_to_status_id>
#       <in_reply_to_user_id>10493972</in_reply_to_user_id>
#       <favorited>false</favorited>
#       <user>
#
#       <id>933291</id>
#       <name>Jeff Turner</name>
#       <screen_name>ResPres</screen_name>
#       <description>I like it when technology brings us together. Founder of RealEstateShows.com. 6 kids. 1 Wife.</description>
#       <location>Los Angeles, CA</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/68647340/photo_2_756472816119ad5212ffeb03f3dcca21_normal.jpg</profile_image_url>
#
#       <url>http://jeffturner.info</url>
#       <protected>false</protected>
#       <followers_count>4087</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415794</id>
#
#       <text>oh, but also, just got today's vlog up. please digg?  http://tinyurl.com/b3hh4g</text>
#       <source>web</source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#
#       <id>14610663</id>
#       <name>Jackie</name>
#       <screen_name>girlwithnoname</screen_name>
#       <description>fitness, weight training, HIIT, interval training, running, swimming, diet &amp;amp; nutrition</description>
#       <location>Vancouver, BC</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/68822024/Neils_Shot_FB_cropped_normal.jpg</profile_image_url>
#
#       <url>http://www.girlwithnoname.com/</url>
#       <protected>false</protected>
#       <followers_count>2059</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415792</id>
#
#       <text>L1 : Lyon/Saint-Etienne, un 86e derby allechant http://bit.ly/13Tt1</text>
#       <source><a href="http://www.twitrss.com/">twitrss</a></source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#
#       <favorited>false</favorited>
#       <user>
#       <id>16188665</id>
#       <name>Lyon News</name>
#       <screen_name>lyonnews</screen_name>
#       <description>Portail d'Actualités de Lyon, France</description>
#
#       <location>Lyon, France</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/65244601/tinytags-2_normal.png</profile_image_url>
#       <url>http://paulantoinem.swurl.com/</url>
#       <protected>false</protected>
#       <followers_count>41</followers_count>
#     </user>
#
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415791</id>
#       <text>@DomainSmith s'hard to fit all that hair in ;) haha - honestly...haven't tried much since the jaw 'appeared' - i should try again (&amp; thanks)</text>
#       <source><a href="http://www.tweetdeck.com/">TweetDeck</a></source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id>1165413092</in_reply_to_status_id>
#       <in_reply_to_user_id>15495536</in_reply_to_user_id>
#       <favorited>false</favorited>
#       <user>
#       <id>14433007</id>
#
#       <name>Carrie Wilkerson</name>
#       <screen_name>barefoot_exec</screen_name>
#       <description>My Mission? To educate, empower, encourage and entertain men &amp;amp; women in business through speaking, writing, connecting and coaching! Profit w/Purpose!</description>
#       <location>Texas</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/74313588/MMshot_normal.jpg</profile_image_url>
#       <url>http://BlogBarefoot.com</url>
#
#       <protected>false</protected>
#       <followers_count>12983</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415790</id>
#       <text>Why i didn't learn English well in high school....... It's so hard to have a nice English resume -.-</text>
#
#       <source>web</source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#       <id>19833444</id>
#
#       <name>pmpmpm Hsu</name>
#       <screen_name>tokpmpm</screen_name>
#       <description />
#       <location />
#       <profile_image_url>http://static.twitter.com/images/default_profile_normal.png</profile_image_url>
#       <url />
#       <protected>false</protected>
#
#       <followers_count>0</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415789</id>
#       <text>@davegoff Dave please reply back, i want to see you try:)</text>
#       <source>web</source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id>1165066747</in_reply_to_status_id>
#       <in_reply_to_user_id>19007284</in_reply_to_user_id>
#       <favorited>false</favorited>
#       <user>
#       <id>14428135</id>
#
#       <name>Daniel Birch</name>
#       <screen_name>danomite84</screen_name>
#       <description>My name is Dan Birch I just graduated Chico-state University and I'm now working in full time Christian ministry with Campus Crusade for Christ.</description>
#       <location>Chico, CA</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/67039558/POSITIVE2_normal.JPG</profile_image_url>
#       <url>http://www.theresurgence.com</url>
#
#       <protected>false</protected>
#       <followers_count>38</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415788</id>
#       <text>Loving a lazy Saturday. Part of my plan to not spend money involves not going out where I could fall into temptation.</text>
#
#       <source>web</source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#       <id>18730271</id>
#
#       <name>Holly Brennan</name>
#       <screen_name>missofg</screen_name>
#       <description>Writer for a defense contracter. I love me some Jesus, my church, foreign missions work, and my music. </description>
#       <location>Southern Maryland</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/70062173/Holly_low-res_normal.jpg</profile_image_url>
#       <url>http://www.hollybrennan.blogspot.com</url>
#
#       <protected>false</protected>
#       <followers_count>144</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415785</id>
#       <text>Fondue is getting shredded ... this is all just going slightly mad ... pls send St Bernards ... #winefest09</text>
#
#       <source><a href="http://twitterfox.net/">TwitterFox</a></source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#
#       <id>14713973</id>
#       <name>Jessica Schilling</name>
#       <screen_name>dzesika</screen_name>
#       <description>Waiting for godets.</description>
#       <location>Cedar Rapids, IA USA</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/60304522/jesssquarebig_normal.jpg</profile_image_url>
#
#       <url>http://www.dzesika.com</url>
#       <protected>false</protected>
#       <followers_count>110</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415784</id>
#
#       <text>@Mrs_Banjer happy happy birthday!</text>
#       <source><a href="http://www.atebits.com/software/tweetie/">Tweetie</a></source>
#       <truncated>false</truncated>
#       <in_reply_to_status_id>1165341513</in_reply_to_status_id>
#       <in_reply_to_user_id>9063322</in_reply_to_user_id>
#
#       <favorited>false</favorited>
#       <user>
#       <id>3189061</id>
#       <name>Jonathan  Nalder</name>
#       <screen_name>jnxyz</screen_name>
#       <description>Over-enthusiastic educational technologist, mLearning specialist, oh &amp; father, hubbie, maker of audio and video...</description>
#
#       <location>iPhone: -26.944351,152.557526</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/15142302/ROAD_DESERT_normal.jpg</profile_image_url>
#       <url>http://www.mlearnxyz.net</url>
#       <protected>false</protected>
#       <followers_count>31</followers_count>
#     </user>
#
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415783</id>
#       <text>@GirlswithGoals Are you okay?</text>
#       <source>web</source>
#       <truncated>false</truncated>
#
#       <in_reply_to_status_id>1165414815</in_reply_to_status_id>
#       <in_reply_to_user_id>8500652</in_reply_to_user_id>
#       <favorited>false</favorited>
#       <user>
#       <id>17278207</id>
#       <name>Terry Hartley</name>
#
#       <screen_name>deucehartley</screen_name>
#       <description>Seriel entrepreneur. Currently doing an 8 part series on the lessons I learned while homeless. Hit the link above!</description>
#       <location>Reston, VA</location>
#       <profile_image_url>http://static.twitter.com/images/default_profile_normal.png</profile_image_url>
#       <url>http://is.gd/8b84</url>
#       <protected>false</protected>
#
#       <followers_count>936</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415782</id>
#       <text>I just got to talk to one of my favorite friends in Italy. Oh, it was fantastic!</text>
#       <source>web</source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#       <id>18580229</id>
#       <name>Jennifer Ross</name>
#
#       <screen_name>rosjl</screen_name>
#       <description></description>
#       <location>Pilgrim House Hostel</location>
#       <profile_image_url>http://s3.amazonaws.com/twitter_production/profile_images/71739755/n33900066_30927185_9572_normal.jpg</profile_image_url>
#       <url>http://gotonmytravelinshoes.blogspot.com/</url>
#       <protected>false</protected>
#
#       <followers_count>23</followers_count>
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415781</id>
#       <text>れっつ２度寝</text>
#       <source><a href="http://www.twittergadget.com">TwitterGadget</a></source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#       <id>18923469</id>
#       <name>こじまじん</name>
#
#       <screen_name>jin_kojima</screen_name>
#       <description></description>
#       <location>横浜</location>
#       <profile_image_url>http://static.twitter.com/images/default_profile_normal.png</profile_image_url>
#       <url></url>
#       <protected>false</protected>
#       <followers_count>5</followers_count>
#
#     </user>
#     </status><status>
#       <created_at>Sat Jan 31 21:57:36 +0000 2009</created_at>
#       <id>1165415780</id>
#       <text>Just saw the Arrington "CrunchPad" prototype on Geekbrief.tv.  Gimmie Gimmie Gimmie!</text>
#       <source><a href="http://help.twitter.com/index.php?pg=kb.page&amp;id=75">txt</a></source>
#
#       <truncated>false</truncated>
#       <in_reply_to_status_id />
#       <in_reply_to_user_id />
#       <favorited>false</favorited>
#       <user>
#       <id>15338749</id>
#       <name>Bmmillss</name>
#
#       <screen_name>Bmmillss</screen_name>
#       <description></description>
#       <location>Northern California</location>
#       <profile_image_url>http://static.twitter.com/images/default_profile_normal.png</profile_image_url>
#       <url>http://www.google.com/reader/shared/16639395948704766342</url>
#       <protected>false</protected>
#
#       <followers_count>16</followers_count>
#     </user>
#     </status>
#     </statuses>

# module Twitter

require 'uri'
require 'xmlsimple'
require 'net/http'

  class PublicTimeline < BaseTimeline
  
    # include RestAPIHelpers
  
    def initialize(source, credential = nil)
      super
    end

    def query
      # log "#{self.class} query"
      # log @source.url.inspect
      
      uri = URI.parse('http://twitter.com')
      # uri = URI.parse(@source.url)
      res = Net::HTTP.start(uri.host, uri.port) {|http|
        http.get("/statuses/public_timeline.xml")
      }
      xml_data = XmlSimple.xml_in(res.body);
      @nested_result = xml_data["status"]
      
    end

    # def sync
    #   @result.each do |item|
    #     item_id = item["id"].first.to_i
    #     item.keys.each do |key|
    #       value = item[key] ? item[key][0] : ""
    #       add_triple(@source.id, id, key.gsub('-','_'), value)
    #       # convert "-" to "_" because "-" is not valid in ruby variable names   
    #     end
    #   end
    # end
      
  # private
  #   def iterate_keys(option)
  #     item = option[:item]
  #     item_id = option[:item_id]
  #     prefix = option[:prefix] || ""
  #     row_num = option[:row_num].to_i
  #     # raise row_num.class.inspect.
  #     
  #     @result[row_num] ||= {}
  #     # item.keys => ["user", "favorited", "truncated"...]
  #     item.keys.each do |key|
  #       # value = item[key] ? item[key] : ""
  #       value = item[key] ? item[key][0] : ""
  #       if value.kind_of?(Hash) && value != {}
  #         # eg. :user => {:url => 'foo} becomes user_url
  #         iterate_keys(:prefix => (prefix + underline(key) + "_"), :item => value, :item_id => item_id, :key => key)
  #       else
  #         # raise item[key][0].inspect
  #         # This method is from rest_api_helper
  #         @result[row_num][prefix + underline(key)] = value
  #         # add_triple(@source.id, item_id, prefix + underline(key), value,  @source.current_user.id)
  #       end
  #     end
  #   end
  # 
  #   def underline(key)
  #     key.gsub('-','_')
  #   end
  end
# end
